@{
    ViewData["Title"] = "Xuất/Nhập Excel Đơn Hàng";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<style>
    .export-card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .btn-export {
        background: #4f6a4c;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
    }
    
    .btn-export:hover {
        background: #3d5239;
        color: white;
    }
    
    .instruction-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 5px;
        padding: 20px;
        margin-top: 20px;
    }
</style>

<div class="hero-wrap hero-bread" style="background-image: url('/images/bg_1.jpg');">
    <div class="container">
        <div class="row no-gutters slider-text align-items-center justify-content-center">
            <div class="col-md-9 ftco-animate text-center">
                <h1 class="mb-0 bread">Xuất/Nhập Excel Đơn Hàng</h1>
                <p class="breadcrumbs">
                    <span class="mr-2"><a asp-action="Dashboard">Dashboard</a></span> 
                    <span>/ Excel</span>
                </p>
            </div>
        </div>
    </div>
</div>

<section class="ftco-section">
    <div class="container">
        <!-- EXPORT SECTION -->
        <div class="export-card">
            <h3 class="mb-4"><i class="fa fa-download"></i> Xuất Đơn Hàng Ra Excel</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label><strong>Chọn khoảng thời gian:</strong></label>
                        <select id="periodSelect" class="form-control">
                            <option value="today">Hôm nay</option>
                            <option value="week">Tuần này</option>
                            <option value="month" selected>Tháng này</option>
                            <option value="custom">Tùy chỉnh</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row" id="customDateRange" style="display: none;">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Từ ngày:</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Đến ngày:</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-export" onclick="exportOrders()">
                <i class="fa fa-file-excel-o"></i> Xuất File Excel
            </button>
            
            <div class="instruction-box">
                <h5><i class="fa fa-info-circle"></i> Hướng dẫn:</h5>
                <ol class="mb-0">
                    <li>Chọn khoảng thời gian muốn xuất đơn hàng</li>
                    <li>Click "Xuất File Excel" để tải file về máy</li>
                    <li>Mở file Excel, tick (☑) vào cột trạng thái mong muốn cho mỗi đơn</li>
                    <li>Lưu file và import lại vào hệ thống bên dưới</li>
                </ol>
            </div>
        </div>
        
        <!-- IMPORT SECTION -->
        <div class="export-card">
            <h3 class="mb-4"><i class="fa fa-upload"></i> Nhập Excel Để Cập Nhật Trạng Thái</h3>
            
            <div class="form-group">
                <label><strong>Chọn file Excel đã chỉnh sửa:</strong></label>
                <input type="file" id="excelFile" class="form-control-file" accept=".xlsx">
                <small class="text-muted">Chỉ chấp nhận file .xlsx</small>
            </div>
            
            <button type="button" class="btn btn-export" onclick="importOrders()">
                <i class="fa fa-upload"></i> Import & Cập Nhật
            </button>
            
            <div id="importResult" class="mt-3"></div>
            
            <div class="instruction-box">
                <h5><i class="fa fa-exclamation-triangle"></i> Lưu ý quan trọng:</h5>
                <ul class="mb-0">
                    <li><strong>KHÔNG XÓA</strong> hoặc thay đổi cột "Mã Đơn"</li>
                    <li>Chỉ tick <strong>1 trạng thái</strong> cho mỗi đơn hàng</li>
                    <li>Sử dụng ký tự <strong>☑</strong> để đánh dấu (copy từ file gốc)</li>
                    <li>Đơn hàng chuyển sang "Đã hoàn thành" sẽ <strong>tự động cộng điểm</strong> cho khách</li>
                </ul>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Show/hide custom date range
        $('#periodSelect').change(function(){
            if($(this).val() === 'custom') {
                $('#customDateRange').show();
            } else {
                $('#customDateRange').hide();
            }
        });
        
        function exportOrders() {
            var period = $('#periodSelect').val();
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();
            
            if(period === 'custom' && (!startDate || !endDate)) {
                alert('Vui lòng chọn ngày bắt đầu và kết thúc!');
                return;
            }
            
            // Create form and submit
            var form = $('<form>', {
                'method': 'POST',
                'action': '@Url.Action("ExportOrdersToExcel", "Staff")'
            });
            
            form.append($('<input>', {
                'type': 'hidden',
                'name': 'period',
                'value': period
            }));
            
            if(period === 'custom') {
                form.append($('<input>', {
                    'type': 'hidden',
                    'name': 'startDate',
                    'value': startDate
                }));
                form.append($('<input>', {
                    'type': 'hidden',
                    'name': 'endDate',
                    'value': endDate
                }));
            }
            
            $('body').append(form);
            form.submit();
            form.remove();
        }
        
        function importOrders() {
            var fileInput = document.getElementById('excelFile');
            if(!fileInput.files || fileInput.files.length === 0) {
                alert('Vui lòng chọn file Excel!');
                return;
            }
            
            var formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            $('#importResult').html('<div class="alert alert-info"><i class="fa fa-spinner fa-spin"></i> Đang xử lý...</div>');
            
            $.ajax({
                url: '@Url.Action("ImportOrdersFromExcel", "Staff")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if(response.success) {
                        var html = '<div class="alert alert-success"><i class="fa fa-check"></i> ' + response.message + '</div>';
                        
                        if(response.errors && response.errors.length > 0) {
                            html += '<div class="alert alert-warning"><strong>Chi tiết lỗi:</strong><ul>';
                            response.errors.forEach(function(error) {
                                html += '<li>' + error + '</li>';
                            });
                            html += '</ul></div>';
                        }
                        
                        $('#importResult').html(html);
                        fileInput.value = '';
                        
                        // Reload sau 2 giây
                        setTimeout(function() {
                            window.location.href = '@Url.Action("Orders", "Staff")';
                        }, 2000);
                    } else {
                        $('#importResult').html('<div class="alert alert-danger"><i class="fa fa-times"></i> ' + response.message + '</div>');
                    }
                },
                error: function() {
                    $('#importResult').html('<div class="alert alert-danger"><i class="fa fa-times"></i> Có lỗi xảy ra khi import file!</div>');
                }
            });
        }
    </script>
}
